<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Canvas 心</title>

    <style>
        /* 页面基础样式 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
            background-image: url('picture/background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* 粒子心动画主 Canvas */
        canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.9;
        }

        #box {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.7;
            pointer-events: none;
        }

        /* 音乐按钮区域 */
        #musicControls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
            text-align: right;
        }

        #musicButton, #addMusicButton {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.9);
            color: #ea8f9d;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        #playlist {
            position: fixed;
            top: 140px;
            right: 20px;
            width: 230px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 10px;
            max-height: 50vh;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .playlist-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }

        .playlist-item.playing {
            background: rgba(234,143,157,0.3);
        }
    </style>
</head>

<body>

<!-- 心形主 canvas -->
<canvas id="pinkboard"></canvas>

<!-- 雪花容器 -->
<div id="box"></div>

<!-- 音乐控制 UI -->
<div id="musicControls">
    <button id="musicButton" onclick="toggleMusic()">▶️ 播放</button>
    <button id="addMusicButton" onclick="document.getElementById('musicInput').click()">➕ 添加音乐</button>
</div>

<input type="file" id="musicInput" accept="audio/*" multiple hidden>
<div id="playlist"></div>

<audio id="backgroundMusic"></audio>

<script>
    /* ——————————————————————————————————————————————
        雪花动画
    —————————————————————————————————————————————— */
    (function () {
        const screenWidth = screen.availWidth;
        const screenHeight = screen.availHeight;

        const snowColors = [
            'rgb(220,182,24)',
            'rgb(198,204,192)',
            'rgb(132,179,148)',
            'rgb(244,211,210)'
        ];

        function Snow(size, downSize) {
            this.box = document.getElementById("box");
            this.size = size;
            this.downSize = downSize || 30;
            this.item = [];
            this.init();
            this.start();
        }

        Snow.prototype.getRandomThings = function(type) {
            switch(type) {
                case 'color': return snowColors[Math.floor(Math.random() * snowColors.length)];
                case 'left': return Math.random() * (screenWidth - 40) + 20;
                case 'top': return -(Math.random() * screenHeight * 0.5 + 100);
                case 'incre': return Math.random() * 0.8 + 1.0;
                case 'increLeft': return 0.6;
                case 'size': return Math.random() * 20 + 10;
            }
        }

        Snow.prototype.init = function() {
            const fragment = document.createDocumentFragment();
            for (let i = 0; i < this.size; i++) {
                const snow = document.createElement("div");
                snow.style.cssText = `
                position: absolute;
                color: ${this.getRandomThings('color')};
                font-size: ${this.getRandomThings('size')}px;
                left: ${this.getRandomThings('left')}px;
                top: ${this.getRandomThings('top')}px;
                pointer-events: none;
            `;
                snow.innerHTML = '&#10052;';
                this.item.push(snow);
                fragment.appendChild(snow);
            }
            this.box.appendChild(fragment);
        }

        Snow.prototype.start = function() {
            this.item.forEach((snow, index) => {
                setTimeout(() => this.animateSnow(snow), (index % this.downSize) * 50);
            });
        }

        Snow.prototype.animateSnow = function(snow) {
            let x = parseFloat(snow.style.left);
            let y = parseFloat(snow.style.top);
            const dx = this.getRandomThings('increLeft');
            const dy = this.getRandomThings('incre');

            const animate = () => {
                if (y > screenHeight || x > screenWidth) {
                    x = this.getRandomThings('left');
                    y = this.getRandomThings('top');
                    snow.style.fontSize = this.getRandomThings('size') + 'px';
                }

                x += dx;
                y += dy;

                snow.style.transform = `translate(${x}px, ${y}px)`;
                requestAnimationFrame(animate);
            }
            requestAnimationFrame(animate);
        }

        new Snow(600, 30);
    })();



    /* ——————————————————————————————————————————————
        音乐播放器
    —————————————————————————————————————————————— */
    let playlist = [];
    let currentTrackIndex = -1;
    let isMusicPlaying = false;

    document.getElementById('musicInput').addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            if (file.type.startsWith('audio/')) {
                playlist.push({
                    name: file.name,
                    url: URL.createObjectURL(file)
                });
            }
        });

        if (playlist.length > 0 && currentTrackIndex === -1) {
            playTrack(0);
        }

        updatePlaylist();
    });

    function updatePlaylist() {
        const playlistDiv = document.getElementById('playlist');
        playlistDiv.innerHTML = '';

        playlist.forEach((track, index) => {
            const item = document.createElement('div');
            item.className = "playlist-item " + (index === currentTrackIndex ? "playing" : "");

            item.innerHTML = `
            <span>${track.name}</span>
            <button onclick="playTrack(${index})">${index === currentTrackIndex ? '⏸' : '▶'}</button>
        `;

            playlistDiv.appendChild(item);
        });
    }

    function playTrack(index) {
        currentTrackIndex = index;
        const music = document.getElementById('backgroundMusic');
        music.src = playlist[index].url;
        music.play();

        isMusicPlaying = true;
        document.getElementById('musicButton').textContent = '⏸ 暂停';

        updatePlaylist();
    }

    function toggleMusic() {
        const music = document.getElementById('backgroundMusic');

        if (playlist.length === 0) {
            alert('请先添加音乐');
            return;
        }

        if (!music.src) playTrack(0);

        if (isMusicPlaying) {
            music.pause();
            document.getElementById('musicButton').textContent = '▶️ 播放';
        } else {
            music.play();
            document.getElementById('musicButton').textContent = '⏸ 暂停';
        }

        isMusicPlaying = !isMusicPlaying;
    }


    /* ——————————————————————————————————————————————
        心形粒子动画（原样保留+整理）
    —————————————————————————————————————————————— */
    var Point = (function () {
        function Point(x, y) {
            this.x = x || 0;
            this.y = y || 0;
        }
        Point.prototype.clone = function () { return new Point(this.x, this.y); };
        Point.prototype.length = function (len) {
            if (len === undefined)
                return Math.sqrt(this.x * this.x + this.y * this.y);
            this.normalize();
            this.x *= len;
            this.y *= len;
            return this;
        };
        Point.prototype.normalize = function () {
            var length = this.length();
            this.x /= length; this.y /= length;
            return this;
        };
        return Point;
    })();

    var settings = {
        particles: {
            length: 1500,
            duration: 3,
            velocity: 90,
            effect: -0.4,
            size: 30
        }
    };

    var colors = [
        {r:139, g:0, b:0},
        {r:220, g:20, b:60},
        {r:128, g:0, b:32},
        {r:139, g:0, b:0}
    ];

    function interpolateColor(c1, c2, f) {
        return {
            r: Math.round(c1.r + (c2.r - c1.r) * f),
            g: Math.round(c1.g + (c2.g - c1.g) * f),
            b: Math.round(c1.b + (c2.b - c1.b) * f)
        };
    }

    var Particle = (function () {
        function Particle() {
            this.position = new Point();
            this.velocity = new Point();
            this.acceleration = new Point();
            this.age = 0;
        }

        Particle.prototype.initialize = function (x, y, dx, dy) {
            this.position.x = x;
            this.position.y = y;
            this.velocity.x = dx;
            this.velocity.y = dy;

            this.acceleration.x = dx * settings.particles.effect;
            this.acceleration.y = dy * settings.particles.effect;

            this.age = 0;
        };

        Particle.prototype.update = function (dt) {
            this.position.x += this.velocity.x * dt;
            this.position.y += this.velocity.y * dt;
            this.velocity.x += this.acceleration.x * dt;
            this.velocity.y += this.acceleration.y * dt;
            this.age += dt;
        };

        Particle.prototype.draw = function (ctx) {
            function ease(t) { return (--t) * t * t + 1; }

            var size = settings.particles.size * ease(this.age / settings.particles.duration);
            ctx.globalAlpha = 1 - this.age / settings.particles.duration;

            var progress = this.age / settings.particles.duration;
            var stage = Math.floor(progress * (colors.length - 1));
            var fac = progress * (colors.length - 1) - stage;

            var color = interpolateColor(colors[stage], colors[(stage + 1) % colors.length], fac);
            ctx.fillStyle = `rgba(${color.r},${color.g},${color.b},${ctx.globalAlpha})`;

            ctx.beginPath();
            ctx.arc(this.position.x, this.position.y, size / 2, 0, Math.PI * 2);
            ctx.fill();
        };

        return Particle;
    })();

    var ParticlePool = (function () {
        var particles, firstActive = 0, firstFree = 0;

        function ParticlePool(len) {
            particles = new Array(len);
            for (var i = 0; i < len; i++) particles[i] = new Particle();
        }

        ParticlePool.prototype.add = function (x, y, dx, dy) {
            particles[firstFree].initialize(x, y, dx, dy);
            firstFree = (firstFree + 1) % particles.length;
            if (firstFree === firstActive)
                firstActive = (firstActive + 1) % particles.length;
        };

        ParticlePool.prototype.update = function (dt) {
            var i = firstActive;
            while (i !== firstFree) {
                particles[i].update(dt);
                if (particles[i].age >= settings.particles.duration) {
                    firstActive = (firstActive + 1) % particles.length;
                }
                i = (i + 1) % particles.length;
            }
        };

        ParticlePool.prototype.draw = function (ctx) {
            var i = firstActive;
            while (i !== firstFree) {
                particles[i].draw(ctx);
                i = (i + 1) % particles.length;
            }
        };

        return ParticlePool;
    })();

    (function (canvas) {
        var ctx = canvas.getContext('2d');
        var particles = new ParticlePool(settings.particles.length);
        var time, particleRate = settings.particles.length / settings.particles.duration;

        function onResize() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
        }

        function pointOnHeart(t) {
            return new Point(
                160 * Math.pow(Math.sin(t), 3),
                130 * Math.cos(t) - 50 * Math.cos(2 * t) - 20 * Math.cos(3 * t) - 10 * Math.cos(4 * t) + 25
            );
        }

        function render() {
            requestAnimationFrame(render);

            var now = Date.now() / 1000;
            var dt = now - (time || now);
            time = now;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            var amount = particleRate * dt;
            for (var i = 0; i < amount; i++) {
                var pos = pointOnHeart(Math.PI - 2 * Math.PI * Math.random());
                var dir = pos.clone().length(settings.particles.velocity);
                particles.add(canvas.width / 2 + pos.x, canvas.height / 2 - pos.y, dir.x, -dir.y);
            }

            drawText(ctx);
            particles.update(dt);
            particles.draw(ctx);
        }

        function drawText(ctx) {
            ctx.save();
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.font = "italic 40px 'Comic Sans MS'";
            ctx.fillStyle = "rgb(234,143,157)";
            ctx.fillText("祝宝李鑫宝天天开心", canvas.width / 2, canvas.height / 2);
            ctx.restore();
        }

        window.onresize = onResize;
        setTimeout(() => { onResize(); render(); }, 20);

    })(document.getElementById("pinkboard"));

</script>
</body>
</html>
